<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>code-sync</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #1e1e1e;
      color: white;
    }
    #editor {
      width: 100%;
      height: 70vh;
    }
    #output {
      width: 100%;
      height: 25vh;
      background: #2d2d2d;
      color: white;
      border: none;
      padding: 10px;
      font-family: Consolas, monospace;
      font-size: 14px;
      overflow-y: auto;
      position: relative;
    }
    #input-box {
      display: none;
      width: 100%;
      padding: 5px;
      font-family: Consolas, monospace;
      font-size: 14px;
      margin-top: 5px;
    }
    #input-box.active {
      display: block;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      background: #007acc;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background: #005a9e;
    }
  </style>
</head>
<body>
  <h2 style="padding: 10px;">üß† Vibe Code Editor</h2>
  <div id="editor"></div>
  <button onclick="runCode()">‚ñ∂Ô∏è Run Code</button>
  <pre id="output">üíª Output will appear here...</pre>
  <textarea id="input-box" placeholder="Enter input here..."></textarea>

  <script>
    let editor;
    let ws = null;
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      editor = monaco.editor.create(document.getElementById('editor'), {
        value: `n = int(input("enter input"))\nprint(n)`,
        language: 'python',
        theme: 'vs-dark',
        fontSize: 14,
        automaticLayout: true
      });
    });

    function connectWebSocket() {
      if (ws) {
        ws.close();
      }
      ws = new WebSocket('ws://' + window.location.host + '/ws/run');
      const output = document.getElementById('output');
      const inputBox = document.getElementById('input-box');

      ws.onopen = () => {
        output.textContent = 'Connected to server...\n';
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'output') {
          output.textContent += data.message;
        } else if (data.type === 'error') {
          output.textContent += 'Error: ' + data.message + '\n';
        } else if (data.type === 'input') {
          output.textContent += data.message;
          inputBox.classList.add('active');
          inputBox.focus();
        }
      };

      ws.onclose = () => {
        output.textContent += 'Disconnected from server.\n';
      };

      ws.onerror = (error) => {
        output.textContent += 'WebSocket error: ' + error + '\n';
      };

      inputBox.addEventListener('keypress', (event) => {
        if (event.key === 'Enter' && inputBox.classList.contains('active')) {
          const input = inputBox.value + '\n';
          ws.send(JSON.stringify({ type: 'input', message: input }));
          inputBox.value = '';
          inputBox.classList.remove('active');
        }
      });
    }

    async function runCode() {
      if (!ws || ws.readyState === WebSocket.CLOSED || ws.readyState === WebSocket.CLOSING) {
        connectWebSocket();
        await new Promise(resolve => setTimeout(resolve, 200)); // Increased delay for connection
      }
      const code = editor.getValue();
      document.getElementById('output').textContent = 'Running...\n';
      ws.send(JSON.stringify({ type: 'code', message: code }));
    }
  </script>
</body>
</html>